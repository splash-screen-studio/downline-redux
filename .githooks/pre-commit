#!/bin/bash
# Pre-commit hook: validate PUBLISH_LOG.yml matches latest Roblox publish

set -e

LOG_FILE="PUBLISH_LOG.yml"

# Load environment
if [ -f ".env" ]; then
    source .env
fi

if [ ! -f "$LOG_FILE" ]; then
    echo "Error: $LOG_FILE not found"
    exit 1
fi

# Check YAML syntax
if ! python3 -c "import yaml; yaml.safe_load(open('$LOG_FILE'))" 2>/dev/null; then
    echo "Error: $LOG_FILE has invalid YAML syntax"
    exit 1
fi

# Check that latest publish is logged via rbxcloud
if [ -n "$ROBLOX_API_KEY" ] && [ -n "$ROBLOX_EXPERIENCE_ID" ] && [ -n "$ROBLOX_PLACE_ID" ]; then
    PLACE_INFO=$(rbxcloud place get -a "$ROBLOX_API_KEY" -u "$ROBLOX_EXPERIENCE_ID" -p "$ROBLOX_PLACE_ID" 2>/dev/null || echo "")

    if [ -n "$PLACE_INFO" ]; then
        python3 << EOF
import json
import yaml
import sys

place_info = json.loads('''$PLACE_INFO''')
roblox_update_time = place_info.get("updateTime", "")

with open("PUBLISH_LOG.yml") as f:
    data = yaml.safe_load(f)

if not data or "publishes" not in data or not data["publishes"]:
    print("Error: PUBLISH_LOG.yml must have at least one publish entry")
    sys.exit(1)

latest = data["publishes"][0]
logged_update_time = latest.get("updateTime", "")

if roblox_update_time != logged_update_time:
    print(f"")
    print(f"⚠️  PUBLISH NOT LOGGED")
    print(f"   Roblox updateTime: {roblox_update_time}")
    print(f"   Logged updateTime: {logged_update_time}")
    print(f"")
    print(f"   Add new entry to PUBLISH_LOG.yml with updateTime from Roblox")
    print(f"")
    sys.exit(1)

# Validate required fields
required = ["updateTime", "commit", "subsystems", "summary"]
missing = [f for f in required if f not in latest]

if missing:
    print(f"Error: Latest publish entry missing fields: {missing}")
    sys.exit(1)

print(f"✓ PUBLISH_LOG.yml matches Roblox ({logged_update_time[:19]})")
EOF
    fi
else
    echo "⚠ Skipping Roblox check (missing .env credentials)"
fi
